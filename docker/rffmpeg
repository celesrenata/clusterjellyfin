#!/bin/bash

# Local ffmpeg for validation (fallback to system ffmpeg if jellyfin-ffmpeg not available)
if [ -x "/usr/lib/jellyfin-ffmpeg/ffmpeg" ]; then
    LOCAL_FFMPEG="/usr/lib/jellyfin-ffmpeg/ffmpeg"
elif [ -x "/usr/bin/ffmpeg" ]; then
    LOCAL_FFMPEG="/usr/bin/ffmpeg"
else
    # If no ffmpeg found, try to find it
    LOCAL_FFMPEG=$(which ffmpeg 2>/dev/null || echo "/usr/bin/ffmpeg")
fi

# Use service name for load balancing across workers
WORKER_SERVICE="jellyfin-clusterjellyfin-workers"
SSH_USER="jellyfin"

# Check for validation flags
case "${1:-}" in
    ""|"-version"|"-f"|"-formats"|"-codecs"|"-decoders"|"-encoders"|"-bsfs"|"-protocols"|"-filters"|"-pix_fmts"|"-layouts"|"-sample_fmts"|"-buildconf")
        exec $LOCAL_FFMPEG "$@"
        ;;
    *)
        # Check if this is a ffprobe operation (metadata probing)
        if [[ "$*" == *"-print_format"* ]] || [[ "$*" == *"-show_streams"* ]] || [[ "$*" == *"-show_chapters"* ]] || [[ "$*" == *"-show_format"* ]]; then
            # Convert deprecated -print_format to -output_format and use ffprobe on worker
            args=$(printf '%q ' "$@")
            args="${args//-print_format/-output_format}"
            ssh -o StrictHostKeyChecking=no -i /home/jellyfin/.ssh/id_rsa $SSH_USER@$WORKER_SERVICE "/usr/lib/jellyfin-ffmpeg/ffprobe $args"
        else
            # This is ffmpeg transcoding - use ffmpeg on worker
            ssh -o StrictHostKeyChecking=no -i /home/jellyfin/.ssh/id_rsa $SSH_USER@$WORKER_SERVICE "/usr/lib/jellyfin-ffmpeg/ffmpeg $(printf '%q ' "$@")"
        fi
        ;;
esac
